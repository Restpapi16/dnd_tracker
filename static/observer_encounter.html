<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>üëÅÔ∏è Observer - –°—Ö–≤–∞—Ç–∫–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --font: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
            --bg: #000000;
            --surface: #070707;
            --surface2: #0b0b0b;
            --stroke: #242424;
            --stroke2: #303030;
            --text: #f8fafc;
            --muted: rgba(248, 250, 252, .66);
            --accent: #fbbf24;
            --accent2: #f59e0b;
            --onAccent: #111827;
            --danger: #ef4444;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 14px 14px 70px;
        }

        .top-card {
            background: linear-gradient(180deg, #060606, #000000);
            border: 1px solid rgba(251, 191, 36, .55);
            border-radius: 14px;
            padding: 12px 14px;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .6), 0 10px 30px rgba(0, 0, 0, .55);
            margin-bottom: 16px;
        }

        .top-title {
            color: var(--accent);
            font-weight: 900;
            font-size: 18px;
        }

        .top-sub {
            color: var(--muted);
            font-size: 13px;
            margin-top: 4px;
        }

        .round-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 16px;
            text-align: center;
        }

        .round-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.10em;
            opacity: 0.7;
            margin: 16px 2px 8px;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .participant {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 14px;
            background: linear-gradient(180deg, var(--surface), var(--surface2));
            border: 1px solid var(--stroke);
            position: relative;
            overflow: hidden;
        }

        .participant.current {
            border-color: var(--accent);
            box-shadow: 0 0 18px rgba(251, 191, 36, 0.30);
            background: radial-gradient(circle at top left, rgba(251, 191, 36, 0.16) 0, transparent 45%),
                        linear-gradient(145deg, #0b0f18, #020617);
        }

        .participant.dead {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .participant.enemy {
            border-left: 3px solid #dc2626;
        }

        .participant.ally {
            border-left: 3px solid #2563eb;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã —Ç—Ä–µ—â–∏–Ω */
        .participant::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 14px;
        }

        /* 50% HP - –º–∞–ª–µ–Ω—å–∫–∏–µ —Ç—Ä–µ—â–∏–Ω—ã */
        .participant.wounded-50::before {
            opacity: 0.3;
            background-image:
                linear-gradient(135deg, transparent 0%, transparent 45%, rgba(220, 38, 38, 0.4) 45%, rgba(220, 38, 38, 0.4) 46%, transparent 46%),
                linear-gradient(225deg, transparent 0%, transparent 45%, rgba(220, 38, 38, 0.4) 45%, rgba(220, 38, 38, 0.4) 46%, transparent 46%);
            background-size: 20px 20px;
            background-position: top left, top right;
            background-repeat: no-repeat, no-repeat;
        }

        /* 25% HP - –±–æ–ª—å—à–µ —Ç—Ä–µ—â–∏–Ω */
        .participant.wounded-25::before {
            opacity: 0.5;
            background-image:
                linear-gradient(135deg, transparent 0%, transparent 40%, rgba(220, 38, 38, 0.6) 40%, rgba(220, 38, 38, 0.6) 42%, transparent 42%),
                linear-gradient(225deg, transparent 0%, transparent 40%, rgba(220, 38, 38, 0.6) 40%, rgba(220, 38, 38, 0.6) 42%, transparent 42%),
                linear-gradient(135deg, transparent 0%, transparent 43%, rgba(220, 38, 38, 0.5) 43%, rgba(220, 38, 38, 0.5) 44%, transparent 44%),
                linear-gradient(90deg, transparent 0%, transparent 48%, rgba(220, 38, 38, 0.4) 48%, rgba(220, 38, 38, 0.4) 49%, transparent 49%);
            background-size: 30px 30px, 30px 30px, 25px 25px, 100% 100%;
            background-position: top left, top right, bottom left, center;
            background-repeat: no-repeat;
        }

        /* 10% HP - –º–Ω–æ–≥–æ —Ç—Ä–µ—â–∏–Ω, –ø—É–ª—å—Å–∞—Ü–∏—è */
        .participant.wounded-10::before {
            opacity: 0.7;
            background-image:
                linear-gradient(135deg, transparent 0%, transparent 35%, rgba(220, 38, 38, 0.8) 35%, rgba(220, 38, 38, 0.8) 38%, transparent 38%),
                linear-gradient(225deg, transparent 0%, transparent 35%, rgba(220, 38, 38, 0.8) 35%, rgba(220, 38, 38, 0.8) 38%, transparent 38%),
                linear-gradient(135deg, transparent 0%, transparent 40%, rgba(220, 38, 38, 0.7) 40%, rgba(220, 38, 38, 0.7) 42%, transparent 42%),
                linear-gradient(225deg, transparent 0%, transparent 42%, rgba(220, 38, 38, 0.6) 42%, rgba(220, 38, 38, 0.6) 43%, transparent 43%),
                linear-gradient(90deg, transparent 0%, transparent 45%, rgba(220, 38, 38, 0.5) 45%, rgba(220, 38, 38, 0.5) 46%, transparent 46%),
                linear-gradient(180deg, transparent 0%, transparent 47%, rgba(220, 38, 38, 0.4) 47%, rgba(220, 38, 38, 0.4) 48%, transparent 48%);
            background-size: 40px 40px, 40px 40px, 35px 35px, 30px 30px, 100% 100%, 100% 100%;
            background-position: top left, top right, bottom left, bottom right, center, center;
            background-repeat: no-repeat;
            animation: crack-pulse 2s ease-in-out infinite;
        }

        @keyframes crack-pulse {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 0.9;
            }
        }

        .p-icon {
            font-size: 24px;
            width: 36px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .p-info {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .p-name {
            font-size: 15px;
            font-weight: 700;
        }

        .p-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }

        .p-init {
            font-size: 16px;
            font-weight: 800;
            color: var(--accent);
            min-width: 36px;
            text-align: right;
            position: relative;
            z-index: 1;
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            margin: 8px 2px;
            text-align: center;
            line-height: 1.5;
        }

        .observer-badge {
            display: inline-block;
            background: rgba(100, 116, 139, 0.2);
            border: 1px solid rgba(100, 116, 139, 0.4);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .btn {
            height: 48px;
            width: 100%;
            padding: 0 16px;
            border-radius: 14px;
            border: 1px solid var(--stroke2);
            background: linear-gradient(135deg, #2a2a2a, #1d1d1d);
            color: var(--text);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
        }

        .btn:active {
            transform: scale(0.99);
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API_BASE = "";

        function authHeaders() {
            const initData = tg?.initData || "";
            return initData ? { "Authorization": "tma " + initData } : {};
        }

        async function apiGet(path) {
            const res = await fetch(API_BASE + path, { headers: { ...authHeaders() } });
            if (!res.ok) throw new Error("HTTP " + res.status);
            return await res.json();
        }

        const urlParams = new URLSearchParams(window.location.search);
        const encounterId = urlParams.get('encounter_id');

        if (!encounterId) {
            document.getElementById('content').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID —Å—Ö–≤–∞—Ç–∫–∏</div>';
        } else {
            loadEncounter();
            setInterval(loadEncounter, 3000); // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        }

        async function loadEncounter() {
            try {
                const state = await apiGet(`/encounters/${encounterId}/state?role=observer`);
                renderEncounter(state);
            } catch (e) {
                console.error(e);
                document.getElementById('content').innerHTML = `<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            }
        }

        function renderEncounter(state) {
            const participants = state.participants || [];
            const currentIdx = state.current_index || 0;

            let html = `
                <div class="top-card">
                    <div class="observer-badge">üëÅÔ∏è Observer Mode</div>
                    <div class="top-title">${state.encounter_name || '–°—Ö–≤–∞—Ç–∫–∞'}</div>
                    <div class="top-sub">–ö–∞–º–ø–∞–Ω–∏—è: ${state.campaign_name}</div>
                </div>

                <div class="round-info">
                    <div class="round-title">üî• –†–∞—É–Ω–¥ ${state.round}</div>
                </div>

                <div class="hint">
                    üëÅÔ∏è –¢—ã –Ω–∞–±–ª—é–¥–∞–µ—à—å –∑–∞ —Å—Ö–≤–∞—Ç–∫–æ–π.<br>
                    HP, –ö–î –∏ –∞—Ç–∞–∫–∏ —Å–∫—Ä—ã—Ç—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ç—Ä–∏–≥–∏.
                </div>

                <div class="section-title">üéØ –ü–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–∞</div>
                <div class="list">
            `;

            if (participants.length === 0) {
                html += '<div class="hint">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç</div>';
            }

            participants.forEach((p, idx) => {
                const isCurrent = idx === currentIdx;
                const isDead = !p.is_alive;
                const isEnemy = p.is_enemy;

                let classes = 'participant';
                if (isCurrent) classes += ' current';
                if (isDead) classes += ' dead';
                if (isEnemy) classes += ' enemy';
                else classes += ' ally';

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ—â–∏–Ω—ã –¥–ª—è –≤—Ä–∞–≥–æ–≤ —Å –Ω–∏–∑–∫–∏–º HP
                if (isEnemy && !isDead && p.current_hp !== undefined && p.max_hp !== undefined) {
                    const hpPercent = (p.current_hp / p.max_hp) * 100;
                    
                    if (hpPercent <= 10) {
                        classes += ' wounded-10';
                    } else if (hpPercent <= 25) {
                        classes += ' wounded-25';
                    } else if (hpPercent <= 50) {
                        classes += ' wounded-50';
                    }
                }

                const icon = isEnemy ? 'üëø' : 'ü§ù';
                const status = isDead ? ' ‚ò†Ô∏è' : '';

                html += `
                    <div class="${classes}">
                        <div class="p-icon">${icon}</div>
                        <div class="p-info">
                            <div class="p-name">${p.name}${status}</div>
                            <div class="p-sub">${isEnemy ? '–í—Ä–∞–≥' : '–°–æ—é–∑–Ω–∏–∫'}</div>
                        </div>
                        <div class="p-init">${p.initiative_total}</div>
                    </div>
                `;
            });

            html += `
                </div>

                <div class="hint">
                    ‚ÑπÔ∏è –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        if (tg && tg.ready) tg.ready();
    </script>
</body>
</html>