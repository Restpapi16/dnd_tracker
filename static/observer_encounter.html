<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>üëÅÔ∏è Observer - –°—Ö–≤–∞—Ç–∫–∞</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --font: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
            --bg: #000000;
            --surface: #070707;
            --surface2: #0b0b0b;
            --stroke: #242424;
            --stroke2: #303030;
            --text: #f8fafc;
            --muted: rgba(248, 250, 252, .66);
            --accent: #fbbf24;
            --accent2: #f59e0b;
            --onAccent: #111827;
            --danger: #ef4444;
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 14px 14px 70px;
        }

        .top-card {
            background: linear-gradient(180deg, #060606, #000000);
            border: 1px solid rgba(251, 191, 36, .55);
            border-radius: 14px;
            padding: 12px 14px;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .6), 0 10px 30px rgba(0, 0, 0, .55);
            margin-bottom: 16px;
        }

        .top-title {
            color: var(--accent);
            font-weight: 900;
            font-size: 18px;
        }

        .top-sub {
            color: var(--muted);
            font-size: 13px;
            margin-top: 4px;
        }

        .round-info {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 16px;
            text-align: center;
        }

        .round-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.10em;
            opacity: 0.7;
            margin: 16px 2px 8px;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .participant {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 14px;
            background: linear-gradient(180deg, var(--surface), var(--surface2));
            border: 1px solid var(--stroke);
            position: relative;
            overflow: hidden;
        }

        .participant.current {
            border-color: var(--accent);
            box-shadow: 0 0 18px rgba(251, 191, 36, 0.30);
            background: radial-gradient(circle at top left, rgba(251, 191, 36, 0.16) 0, transparent 45%),
                        linear-gradient(145deg, #0b0f18, #020617);
        }

        .participant.dead {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .participant.enemy {
            border-left: 3px solid #dc2626;
        }

        .participant.ally {
            border-left: 3px solid #2563eb;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç –±–∏—Ç–æ–≥–æ —Å—Ç–µ–∫–ª–∞ */
        .participant::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 14px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100% 100%;
        }

        /* 50% HP - –æ–¥–∏–Ω —É–¥–∞—Ä (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª) */
        .participant.wounded-50::before {
            opacity: 0.6;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Cg%3E%3Ccircle cx='240' cy='20' r='3' fill='%23dc2626' opacity='0.8'/%3E%3Cline x1='240' y1='20' x2='260' y2='10' stroke='%239a0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='270' y2='25' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='265' y2='35' stroke='%23a00000' stroke-width='0.9' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='230' y2='10' stroke='%239a0000' stroke-width='1.1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='220' y2='15' stroke='%23a00000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='235' y2='35' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='225' y2='30' stroke='%23a00000' stroke-width='0.8' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='245' y2='40' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='255' y2='45' stroke='%23a00000' stroke-width='0.8' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* 25% HP - –¥–≤–∞ —É–¥–∞—Ä–∞ (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö + –ª–µ–≤—ã–π –Ω–∏–∑) */
        .participant.wounded-25::before {
            opacity: 0.7;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Cg%3E%3Ccircle cx='240' cy='20' r='3' fill='%23dc2626' opacity='0.9'/%3E%3Cline x1='240' y1='20' x2='265' y2='8' stroke='%238b0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='240' y1='20' x2='275' y2='22' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='270' y2='38' stroke='%239a0000' stroke-width='1.1' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='225' y2='8' stroke='%238b0000' stroke-width='1.3' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='215' y2='15' stroke='%239a0000' stroke-width='1.1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='230' y2='38' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='220' y2='32' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='245' y2='42' stroke='%238b0000' stroke-width='1.1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='258' y2='48' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='210' y2='25' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='280' y2='32' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='60' cy='75' r='3' fill='%23dc2626' opacity='0.9'/%3E%3Cline x1='60' y1='75' x2='40' y2='68' stroke='%238b0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='60' y1='75' x2='30' y2='75' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='35' y2='85' stroke='%239a0000' stroke-width='1.1' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='75' y2='65' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='85' y2='70' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='70' y2='88' stroke='%238b0000' stroke-width='1.1' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='80' y2='82' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='50' y2='90' stroke='%238b0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='45' y2='55' stroke='%239a0000' stroke-width='0.9' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='90' y2='78' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='60' y1='75' x2='25' y2='65' stroke='%239a0000' stroke-width='0.8' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* 10% HP - —Ç—Ä–∏ —É–¥–∞—Ä–∞ (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö + –ª–µ–≤—ã–π –Ω–∏–∑ + —Ü–µ–Ω—Ç—Ä) + –ø—É–ª—å—Å–∞—Ü–∏—è */
        .participant.wounded-10::before {
            opacity: 0.85;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Cg%3E%3Ccircle cx='240' cy='18' r='4' fill='%23dc2626' opacity='1'/%3E%3Cline x1='240' y1='18' x2='268' y2='5' stroke='%237a0000' stroke-width='1.6' opacity='0.9'/%3E%3Cline x1='240' y1='18' x2='280' y2='20' stroke='%237a0000' stroke-width='1.4' opacity='0.85'/%3E%3Cline x1='240' y1='18' x2='275' y2='38' stroke='%238b0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='240' y1='18' x2='220' y2='5' stroke='%237a0000' stroke-width='1.5' opacity='0.85'/%3E%3Cline x1='240' y1='18' x2='210' y2='12' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='240' y1='18' x2='225' y2='38' stroke='%237a0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='240' y1='18' x2='215' y2='30' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='18' x2='245' y2='45' stroke='%237a0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='240' y1='18' x2='260' y2='50' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='18' x2='205' y2='22' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='240' y1='18' x2='285' y2='30' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='268' y1='5' x2='280' y2='0' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3Cline x1='220' y1='5' x2='208' y2='0' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='55' cy='78' r='4' fill='%23dc2626' opacity='1'/%3E%3Cline x1='55' y1='78' x2='32' y2='68' stroke='%237a0000' stroke-width='1.5' opacity='0.9'/%3E%3Cline x1='55' y1='78' x2='25' y2='75' stroke='%237a0000' stroke-width='1.4' opacity='0.85'/%3E%3Cline x1='55' y1='78' x2='30' y2='88' stroke='%238b0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='55' y1='78' x2='75' y2='65' stroke='%237a0000' stroke-width='1.4' opacity='0.85'/%3E%3Cline x1='55' y1='78' x2='88' y2='70' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='55' y1='78' x2='68' y2='90' stroke='%237a0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='55' y1='78' x2='82' y2='85' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='55' y1='78' x2='48' y2='95' stroke='%237a0000' stroke-width='1.2' opacity='0.75'/%3E%3Cline x1='55' y1='78' x2='42' y2='55' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='55' y1='78' x2='95' y2='80' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='55' y1='78' x2='20' y2='65' stroke='%238b0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='32' y1='68' x2='22' y2='60' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3Cline x1='75' y1='65' x2='85' y2='55' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='150' cy='45' r='4' fill='%23dc2626' opacity='1'/%3E%3Cline x1='150' y1='45' x2='170' y2='30' stroke='%237a0000' stroke-width='1.5' opacity='0.85'/%3E%3Cline x1='150' y1='45' x2='180' y2='42' stroke='%237a0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='150' y1='45' x2='175' y2='60' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='150' y1='45' x2='130' y2='30' stroke='%237a0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='150' y1='45' x2='120' y2='40' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='150' y1='45' x2='135' y2='62' stroke='%237a0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='150' y1='45' x2='125' y2='55' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='150' y1='45' x2='155' y2='68' stroke='%237a0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='150' y1='45' x2='165' y2='70' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='150' y1='45' x2='115' y2='48' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='150' y1='45' x2='185' y2='52' stroke='%238b0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='150' y1='45' x2='145' y2='25' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='170' y1='30' x2='182' y2='22' stroke='%239a0000' stroke-width='0.8' opacity='0.6'/%3E%3Cline x1='130' y1='30' x2='118' y2='22' stroke='%239a0000' stroke-width='0.8' opacity='0.6'/%3E%3C/g%3E%3C/svg%3E");
            animation: crack-pulse 2s ease-in-out infinite;
        }

        @keyframes crack-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.95; }
        }

        .p-icon {
            font-size: 24px;
            width: 36px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .p-info {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .p-name {
            font-size: 15px;
            font-weight: 700;
        }

        .p-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 2px;
        }

        .p-init {
            font-size: 16px;
            font-weight: 800;
            color: var(--accent);
            min-width: 36px;
            text-align: right;
            position: relative;
            z-index: 1;
        }

        .hint {
            font-size: 12px;
            color: var(--muted);
            margin: 8px 2px;
            text-align: center;
            line-height: 1.5;
        }

        .observer-badge {
            display: inline-block;
            background: rgba(100, 116, 139, 0.2);
            border: 1px solid rgba(100, 116, 139, 0.4);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        .btn {
            height: 48px;
            width: 100%;
            padding: 0 16px;
            border-radius: 14px;
            border: 1px solid var(--stroke2);
            background: linear-gradient(135deg, #2a2a2a, #1d1d1d);
            color: var(--text);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 12px;
        }

        .btn:active {
            transform: scale(0.99);
        }
    </style>
</head>
<body>
    <div id="content">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API_BASE = "";

        function authHeaders() {
            const initData = tg?.initData || "";
            return initData ? { "Authorization": "tma " + initData } : {};
        }

        async function apiGet(path) {
            const res = await fetch(API_BASE + path, { headers: { ...authHeaders() } });
            if (!res.ok) throw new Error("HTTP " + res.status);
            return await res.json();
        }

        const urlParams = new URLSearchParams(window.location.search);
        const encounterId = urlParams.get('encounter_id');

        if (!encounterId) {
            document.getElementById('content').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID —Å—Ö–≤–∞—Ç–∫–∏</div>';
        } else {
            loadEncounter();
            setInterval(loadEncounter, 3000); // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        }

        async function loadEncounter() {
            try {
                const state = await apiGet(`/encounters/${encounterId}/state?role=observer`);
                renderEncounter(state);
            } catch (e) {
                console.error(e);
                document.getElementById('content').innerHTML = `<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</div>`;
            }
        }

        function renderEncounter(state) {
            const participants = state.participants || [];
            const currentIdx = state.current_index || 0;

            let html = `
                <div class="top-card">
                    <div class="observer-badge">üëÅÔ∏è Observer Mode</div>
                    <div class="top-title">${state.encounter_name || '–°—Ö–≤–∞—Ç–∫–∞'}</div>
                    <div class="top-sub">–ö–∞–º–ø–∞–Ω–∏—è: ${state.campaign_name}</div>
                </div>

                <div class="round-info">
                    <div class="round-title">üî• –†–∞—É–Ω–¥ ${state.round}</div>
                </div>

                <div class="hint">
                    üëÅÔ∏è –¢—ã –Ω–∞–±–ª—é–¥–∞–µ—à—å –∑–∞ —Å—Ö–≤–∞—Ç–∫–æ–π.<br>
                    HP, –ö–î –∏ –∞—Ç–∞–∫–∏ —Å–∫—Ä—ã—Ç—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ç—Ä–∏–≥–∏.
                </div>

                <div class="section-title">üéØ –ü–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–∞</div>
                <div class="list">
            `;

            if (participants.length === 0) {
                html += '<div class="hint">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç</div>';
            }

            participants.forEach((p, idx) => {
                const isCurrent = idx === currentIdx;
                const isDead = !p.is_alive;
                const isEnemy = p.is_enemy;

                let classes = 'participant';
                if (isCurrent) classes += ' current';
                if (isDead) classes += ' dead';
                if (isEnemy) classes += ' enemy';
                else classes += ' ally';

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ—â–∏–Ω—ã –¥–ª—è –≤—Ä–∞–≥–æ–≤ —Å –Ω–∏–∑–∫–∏–º HP
                if (isEnemy && !isDead && p.current_hp !== undefined && p.max_hp !== undefined) {
                    const hpPercent = (p.current_hp / p.max_hp) * 100;
                    
                    if (hpPercent <= 10) {
                        classes += ' wounded-10';
                    } else if (hpPercent <= 25) {
                        classes += ' wounded-25';
                    } else if (hpPercent <= 50) {
                        classes += ' wounded-50';
                    }
                }

                const icon = isEnemy ? 'üëø' : 'ü§ù';
                const status = isDead ? ' ‚ò†Ô∏è' : '';

                html += `
                    <div class="${classes}">
                        <div class="p-icon">${icon}</div>
                        <div class="p-info">
                            <div class="p-name">${p.name}${status}</div>
                            <div class="p-sub">${isEnemy ? '–í—Ä–∞–≥' : '–°–æ—é–∑–Ω–∏–∫'}</div>
                        </div>
                        <div class="p-init">${p.initiative_total}</div>
                    </div>
                `;
            });

            html += `
                </div>

                <div class="hint">
                    ‚ÑπÔ∏è –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        if (tg && tg.ready) tg.ready();
    </script>
</body>
</html>