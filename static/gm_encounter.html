<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>GM Encounter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --font: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --bg: #000000;
      --surface: #070707;
      --surface2: #0b0b0b;
      --stroke: #242424;
      --stroke2: #303030;
      --text: #f8fafc;
      --muted: rgba(248, 250, 252, .66);
      --accent: #fbbf24;
      --accent2: #f59e0b;
      --onAccent: #111827;
      --danger: #ef4444;
      --danger2: #991b1b;
      --onDanger: #ffffff;
      --focus: rgba(251, 191, 36, .55);
    }
    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 14px 14px 136px;
    }
    .top-card {
      background: linear-gradient(180deg, #060606, #000000);
      border: 1px solid rgba(251, 191, 36, .55);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, .6), 0 10px 30px rgba(0, 0, 0, .55);
    }
    .top-title { color: var(--accent); font-weight: 900; }
    .top-sub { color: var(--muted); }
    .top-row { display: flex; justify-content: space-between; gap: 10px; align-items: center; margin-top: 10px; }
    .pill {
      font-size: 12px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(251, 191, 36, .35);
      background: radial-gradient(circle at top left, rgba(251, 191, 36, .18) 0, transparent 55%), linear-gradient(180deg, #151515, #070707);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, .55);
      white-space: nowrap;
    }
    .observer-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke2);
      background: rgba(100, 116, 139, 0.1);
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s ease;
    }
    .observer-toggle:active { transform: scale(0.98); }
    .observer-toggle.active {
      background: rgba(251, 191, 36, 0.15);
      border-color: var(--accent);
    }
    .observer-toggle-icon { font-size: 16px; }
    .observer-toggle-text { font-size: 12px; font-weight: 700; }
    .status-line { font-size: 12px; margin-top: 8px; min-height: 16px; opacity: 0.9; }
    .section-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.10em; opacity: 0.7; margin: 10px 2px 8px; }
    .list { display: flex; flex-direction: column; gap: 10px; }
    .card {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px;
      border-radius: 16px;
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border: 1px solid var(--stroke);
      min-height: 62px;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    .card:active { transform: scale(0.99); }
    .card-main { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; position: relative; z-index: 1; }
    .card.current {
      border-color: var(--accent);
      box-shadow: 0 0 16px rgba(251, 191, 36, 0.25);
      background: radial-gradient(circle at top left, rgba(251, 191, 36, 0.14) 0, transparent 45%), linear-gradient(145deg, #0b1220, #020617);
    }
    .card.selected { outline: 2px solid rgba(96, 165, 250, 0.85); outline-offset: 0px; }
    .card.dead { opacity: 0.55; }
    
    /* –≠—Ñ—Ñ–µ–∫—Ç –±–∏—Ç–æ–≥–æ —Å—Ç–µ–∫–ª–∞ */
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 16px;
      background-repeat: no-repeat;
      background-position: center;
      background-size: 100% 100%;
    }
    
    /* 50% HP - –æ–¥–∏–Ω —É–¥–∞—Ä (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª) */
    .card.wounded-50::before {
      opacity: 0.6;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Cg%3E%3Ccircle cx='240' cy='20' r='3' fill='%23dc2626' opacity='0.8'/%3E%3Cline x1='240' y1='20' x2='260' y2='10' stroke='%239a0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='270' y2='25' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='265' y2='35' stroke='%23a00000' stroke-width='0.9' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='230' y2='10' stroke='%239a0000' stroke-width='1.1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='220' y2='15' stroke='%23a00000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='235' y2='35' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='225' y2='30' stroke='%23a00000' stroke-width='0.8' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='245' y2='40' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='255' y2='45' stroke='%23a00000' stroke-width='0.8' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
    }
    
    /* 25% HP - –¥–≤–∞ —É–¥–∞—Ä–∞ (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö + –ª–µ–≤—ã–π –Ω–∏–∑) */
    .card.wounded-25::before {
      opacity: 0.7;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Cg%3E%3Ccircle cx='240' cy='20' r='3' fill='%23dc2626' opacity='0.9'/%3E%3Cline x1='240' y1='20' x2='265' y2='8' stroke='%238b0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='240' y1='20' x2='275' y2='22' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='270' y2='38' stroke='%239a0000' stroke-width='1.1' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='225' y2='8' stroke='%238b0000' stroke-width='1.3' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='215' y2='15' stroke='%239a0000' stroke-width='1.1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='230' y2='38' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='20' x2='220' y2='32' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='245' y2='42' stroke='%238b0000' stroke-width='1.1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='258' y2='48' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='240' y1='20' x2='210' y2='25' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='240' y1='20' x2='280' y2='32' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='60' cy='75' r='3' fill='%23dc2626' opacity='0.9'/%3E%3Cline x1='60' y1='75' x2='40' y2='68' stroke='%238b0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='60' y1='75' x2='30' y2='75' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='35' y2='85' stroke='%239a0000' stroke-width='1.1' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='75' y2='65' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='85' y2='70' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='70' y2='88' stroke='%238b0000' stroke-width='1.1' opacity='0.7'/%3E%3Cline x1='60' y1='75' x2='80' y2='82' stroke='%239a0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='50' y2='90' stroke='%238b0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='45' y2='55' stroke='%239a0000' stroke-width='0.9' opacity='0.6'/%3E%3Cline x1='60' y1='75' x2='90' y2='78' stroke='%239a0000' stroke-width='0.9' opacity='0.5'/%3E%3Cline x1='60' y1='75' x2='25' y2='65' stroke='%239a0000' stroke-width='0.8' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
    }
    
    /* 10% HP - —Ç—Ä–∏ —É–¥–∞—Ä–∞ (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö + –ª–µ–≤—ã–π –Ω–∏–∑ + —Ü–µ–Ω—Ç—Ä) + –ø—É–ª—å—Å–∞—Ü–∏—è */
    .card.wounded-10::before {
      opacity: 0.85;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 100'%3E%3Cg%3E%3Ccircle cx='240' cy='18' r='4' fill='%23dc2626' opacity='1'/%3E%3Cline x1='240' y1='18' x2='268' y2='5' stroke='%237a0000' stroke-width='1.6' opacity='0.9'/%3E%3Cline x1='240' y1='18' x2='280' y2='20' stroke='%237a0000' stroke-width='1.4' opacity='0.85'/%3E%3Cline x1='240' y1='18' x2='275' y2='38' stroke='%238b0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='240' y1='18' x2='220' y2='5' stroke='%237a0000' stroke-width='1.5' opacity='0.85'/%3E%3Cline x1='240' y1='18' x2='210' y2='12' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='240' y1='18' x2='225' y2='38' stroke='%237a0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='240' y1='18' x2='215' y2='30' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='18' x2='245' y2='45' stroke='%237a0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='240' y1='18' x2='260' y2='50' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='240' y1='18' x2='205' y2='22' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='240' y1='18' x2='285' y2='30' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='268' y1='5' x2='280' y2='0' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3Cline x1='220' y1='5' x2='208' y2='0' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='55' cy='78' r='4' fill='%23dc2626' opacity='1'/%3E%3Cline x1='55' y1='78' x2='32' y2='68' stroke='%237a0000' stroke-width='1.5' opacity='0.9'/%3E%3Cline x1='55' y1='78' x2='25' y2='75' stroke='%237a0000' stroke-width='1.4' opacity='0.85'/%3E%3Cline x1='55' y1='78' x2='30' y2='88' stroke='%238b0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='55' y1='78' x2='75' y2='65' stroke='%237a0000' stroke-width='1.4' opacity='0.85'/%3E%3Cline x1='55' y1='78' x2='88' y2='70' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='55' y1='78' x2='68' y2='90' stroke='%237a0000' stroke-width='1.3' opacity='0.8'/%3E%3Cline x1='55' y1='78' x2='82' y2='85' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='55' y1='78' x2='48' y2='95' stroke='%237a0000' stroke-width='1.2' opacity='0.75'/%3E%3Cline x1='55' y1='78' x2='42' y2='55' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='55' y1='78' x2='95' y2='80' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='55' y1='78' x2='20' y2='65' stroke='%238b0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='32' y1='68' x2='22' y2='60' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3Cline x1='75' y1='65' x2='85' y2='55' stroke='%238b0000' stroke-width='0.8' opacity='0.6'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='150' cy='45' r='4' fill='%23dc2626' opacity='1'/%3E%3Cline x1='150' y1='45' x2='170' y2='30' stroke='%237a0000' stroke-width='1.5' opacity='0.85'/%3E%3Cline x1='150' y1='45' x2='180' y2='42' stroke='%237a0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='150' y1='45' x2='175' y2='60' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='150' y1='45' x2='130' y2='30' stroke='%237a0000' stroke-width='1.4' opacity='0.8'/%3E%3Cline x1='150' y1='45' x2='120' y2='40' stroke='%238b0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='150' y1='45' x2='135' y2='62' stroke='%237a0000' stroke-width='1.3' opacity='0.75'/%3E%3Cline x1='150' y1='45' x2='125' y2='55' stroke='%238b0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='150' y1='45' x2='155' y2='68' stroke='%237a0000' stroke-width='1.2' opacity='0.7'/%3E%3Cline x1='150' y1='45' x2='165' y2='70' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='150' y1='45' x2='115' y2='48' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='150' y1='45' x2='185' y2='52' stroke='%238b0000' stroke-width='1' opacity='0.6'/%3E%3Cline x1='150' y1='45' x2='145' y2='25' stroke='%238b0000' stroke-width='1.1' opacity='0.65'/%3E%3Cline x1='170' y1='30' x2='182' y2='22' stroke='%239a0000' stroke-width='0.8' opacity='0.6'/%3E%3Cline x1='130' y1='30' x2='118' y2='22' stroke='%239a0000' stroke-width='0.8' opacity='0.6'/%3E%3C/g%3E%3C/svg%3E");
      animation: crack-pulse 2s ease-in-out infinite;
    }
    
    @keyframes crack-pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.95; }
    }
    
    .title { font-size: 16px; font-weight: 900; line-height: 1.15; }
    .sub { margin-top: 4px; font-size: 12px; color: var(--muted); }
    .badges { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; position: relative; z-index: 1; }
    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      font-size: 11px;
      letter-spacing: .06em;
      text-transform: uppercase;
      background: rgba(255, 255, 255, .04);
    }
    .badge.enemy { background: rgba(220, 38, 38, .12); border-color: rgba(220, 38, 38, .35); }
    .badge.pc { background: rgba(37, 99, 235, .12); border-color: rgba(37, 99, 235, .35); }
    .badge.zero { background: rgba(245, 158, 11, .12); border-color: rgba(245, 158, 11, .35); }
    .right { text-align: right; min-width: 96px; position: relative; z-index: 1; }
    .hp { font-size: 14px; font-weight: 900; margin-top: 2px; }
    .hp.muted { color: var(--muted); font-weight: 700; }
    .attacks-block {
      margin-top: 10px;
      padding: 10px;
      background: rgba(127, 29, 29, 0.15);
      border-radius: 10px;
      border: 1px solid rgba(127, 29, 29, 0.35);
      position: relative;
      z-index: 1;
    }
    .attacks-title { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); margin-bottom: 6px; }
    .attack-item { margin-top: 6px; padding: 6px 8px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 1px solid rgba(127, 29, 29, 0.25); }
    .attack-name { font-size: 12px; font-weight: 700; color: var(--text); }
    .attack-stats { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .bottom-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(2, 6, 23, .92);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--stroke);
      z-index: 1500;
    }
    .bottom-row { display: flex; gap: 10px; }
    .bottom-row + .bottom-row { margin-top: 10px; }
    .bottom-row .btn {
      flex: 1;
      height: 52px;
      border-radius: 16px;
      border: 1px solid #0f172a;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #111827;
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .05em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.7);
    }
    .bottom-row .btn.secondary { background: linear-gradient(135deg, #2a2a2a, #1d1d1d); color: var(--text); border: 1px solid var(--stroke2); }
    .bottom-row .btn.danger { background: linear-gradient(135deg, var(--danger), var(--danger2)); color: var(--onDanger); border: 1px solid rgba(0, 0, 0, .35); }
    .bottom-row .btn:active { transform: scale(0.99); }
    .bottom-row .btn.primary { background: linear-gradient(180deg, #2a2a2a, #151515); color: var(--text); border: 1px solid rgba(251, 191, 36, .55); box-shadow: 0 0 0 1px rgba(0, 0, 0, .6), 0 8px 18px rgba(0, 0, 0, .45); }
    .toast {
      position: fixed; left: 50%; bottom: 18px;
      transform: translateX(-50%) translateY(20px);
      min-width: 220px; max-width: 90vw;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid #78350f;
      color: #f9fafb;
      font-size: 12px;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      z-index: 2500;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .hpbtn { height: 44px; min-width: 52px; padding: 0 10px; border-radius: 14px; border: 1px solid var(--stroke2); background: linear-gradient(180deg, #222, #111); color: var(--text); font-weight: 900; font-size: 13px; }
    .hpbtn:active { transform: scale(0.99); }
    .hpwho { flex: 1; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 14px; border: 1px dashed rgba(251, 191, 36, .35); color: rgba(251, 191, 36, .95); font-weight: 900; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
</head>
<body>
  <div class="top-card">
    <div class="top-title" id="encounterName">–°—Ö–≤–∞—Ç–∫–∞</div>
    <div class="top-sub" id="campaignName">–ö–∞–º–ø–∞–Ω–∏—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞</div>
    <div class="top-row">
      <div class="pill" id="roundInfo">–†–∞—É–Ω–¥ ?</div>
      <div class="pill" id="turnInfo">–•–æ–¥ ?</div>
    </div>
    <div class="observer-toggle" id="observerToggle">
      <span class="observer-toggle-icon">üëÅÔ∏è</span>
      <span class="observer-toggle-text">–†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è</span>
    </div>
    <div class="status-line" id="statusLine"></div>
  </div>
  <div class="section-title">–ü–æ—Ä—è–¥–æ–∫ —Ö–æ–¥–æ–≤</div>
  <div id="participants" class="list"></div>
  <div class="section-title">HP</div>
  <div id="hpControls" class="hp-controls"></div>
  <div class="hint">–¢–∞–ø –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É –≤—ã–±–∏—Ä–∞–µ—Ç –µ–≥–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è HP.</div>
  <div class="bottom-bar">
    <div class="bottom-row">
      <button id="nextTurnBtn" class="btn primary">–°–ª–µ–¥—É—é—â–∏–π</button>
    </div>
    <div class="bottom-row" id="hpBarRow" style="display:none;">
      <button class="hpbtn" data-d="-10">-10</button>
      <button class="hpbtn" data-d="-5">-5</button>
      <button class="hpbtn" data-d="-1">-1</button>
      <div class="hpwho" id="hpWho">HP</div>
      <button class="hpbtn" data-d="1">+1</button>
      <button class="hpbtn" data-d="5">+5</button>
      <button class="hpbtn" data-d="10">+10</button>
    </div>
    <div class="bottom-row">
      <button id="finishBtn" class="btn danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <button id="backToCampaignsBtn" class="btn secondary">–ö –∫–∞–º–ø–∞–Ω–∏—è–º</button>
    </div>
  </div>
  <div id="toast" class="toast"></div>
  <script>
    const tg = window.Telegram.WebApp;
    function authHeaders() {
      const initData = tg?.initData || "";
      return initData ? { "Authorization": "tma " + initData } : {};
    }
    const API_BASE = "";
    const urlParams = new URLSearchParams(window.location.search);
    let encounterId = urlParams.get("encounter_id") || urlParams.get("tgWebAppStartParam");
    if (!encounterId && tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
      encounterId = tg.initDataUnsafe.start_param;
    }
    if (!encounterId) document.getElementById("statusLine").innerText = "–ù–µ—Ç encounter_id";
    
    // Observer mode state
    let observerMode = localStorage.getItem('gm_observer_mode') === 'true';
    const observerToggle = document.getElementById('observerToggle');
    
    // Toggle observer mode
    observerToggle.onclick = () => {
      observerMode = !observerMode;
      localStorage.setItem('gm_observer_mode', observerMode);
      updateObserverToggle();
      renderState();
    };
    
    function updateObserverToggle() {
      if (observerMode) {
        observerToggle.classList.add('active');
      } else {
        observerToggle.classList.remove('active');
      }
    }
    
    let currentState = null;
    let selectedParticipantId = null;
    async function apiGet(path) {
      const res = await fetch(API_BASE + path, { headers: { ...authHeaders() } });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }
    async function apiPost(path, body) {
      const res = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...authHeaders() },
        body: body ? JSON.stringify(body) : "{}"
      });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }
    function formatDamage(numDice, dieSize, bonus) {
      let result = '';
      if (numDice > 0 && dieSize > 0) {
        result = `${numDice}d${dieSize}`;
        if (bonus !== 0) result += bonus > 0 ? `+${bonus}` : `${bonus}`;
      } else if (bonus !== 0) {
        result = `${bonus}`;
      } else {
        result = '0';
      }
      return result;
    }
    async function loadState() {
      if (!encounterId) return;
      setFlavorStatus("loading_state");
      try {
        const state = await apiGet(`/encounters/${encounterId}/state?role=gm`);
        currentState = state;
        renderState();
        clearStatus();
      } catch (e) {
        console.error(e);
        setFlavorStatus("error_state");
      }
    }
    function renderState() {
      if (!currentState) return;
      document.getElementById("encounterName").innerText = currentState.encounter_name ? currentState.encounter_name : `–°—Ö–≤–∞—Ç–∫–∞ #${currentState.encounter_id}`;
      document.getElementById("campaignName").innerText = currentState.campaign_name ? `–ö–∞–º–ø–∞–Ω–∏—è "${currentState.campaign_name}"` : `–ö–∞–º–ø–∞–Ω–∏—è #${currentState.campaign_id}`;
      document.getElementById("roundInfo").innerText = `–†–∞—É–Ω–¥ ${currentState.round}`;
      const total = currentState.participants.length;
      document.getElementById("turnInfo").innerText = `–•–æ–¥ ${currentState.current_index + 1} –∏–∑ ${total}`;
      
      updateObserverToggle();
      
      const container = document.getElementById("participants");
      container.innerHTML = "";
      currentState.participants.forEach((p, index) => {
        const card = document.createElement("div");
        let cardClasses = "card";
        if (index === currentState.current_index) cardClasses += " current";
        if (!p.is_alive) cardClasses += " dead";
        if (selectedParticipantId === p.id) cardClasses += " selected";
        
        // Add wound classes in observer mode for enemies
        if (observerMode && p.is_enemy && p.is_alive && p.current_hp !== undefined && p.max_hp !== undefined) {
          const hpPercent = (p.current_hp / p.max_hp) * 100;
          if (hpPercent <= 10) {
            cardClasses += ' wounded-10';
          } else if (hpPercent <= 25) {
            cardClasses += ' wounded-25';
          } else if (hpPercent <= 50) {
            cardClasses += ' wounded-50';
          }
        }
        
        card.className = cardClasses;
        card.onclick = () => {
          selectedParticipantId = (selectedParticipantId === p.id) ? null : p.id;
          renderState();
        };
        const mainRow = document.createElement("div");
        mainRow.className = "card-main";
        const left = document.createElement("div");
        left.style.flex = "1";
        const title = document.createElement("div");
        title.className = "title";
        title.innerText = p.name;
        left.appendChild(title);
        const sub = document.createElement("div");
        sub.className = "sub";
        sub.innerText = `–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞: ${p.initiative_total}, –ö–î: ${p.ac ?? "-"}`;
        left.appendChild(sub);
        const badges = document.createElement("div");
        badges.className = "badges";
        const roleBadge = document.createElement("span");
        roleBadge.className = "badge " + (p.is_enemy ? "enemy" : "pc");
        roleBadge.innerText = p.is_enemy ? "–í—Ä–∞–≥" : "–ò–≥—Ä–æ–∫";
        badges.appendChild(roleBadge);
        if (!p.is_alive) {
          const deadBadge = document.createElement("span");
          deadBadge.className = "badge zero";
          deadBadge.innerText = "0 HP";
          badges.appendChild(deadBadge);
        }
        left.appendChild(badges);
        const right = document.createElement("div");
        right.className = "right";
        
        // HP display: always show exact numbers, cracks show status
        const hp = document.createElement("div");
        hp.className = "hp" + ((p.max_hp == null || p.current_hp == null) ? " muted" : "");
        if (p.max_hp != null && p.current_hp != null) {
          hp.innerText = `${p.current_hp}/${p.max_hp}`;
        } else {
          hp.innerText = "‚Äî";
        }
        right.appendChild(hp);
        
        mainRow.appendChild(left);
        mainRow.appendChild(right);
        card.appendChild(mainRow);
        
        // Hide attacks in observer mode
        if (!observerMode && p.attacks && p.attacks.length > 0) {
          const attacksBlock = document.createElement("div");
          attacksBlock.className = "attacks-block";
          const attacksTitle = document.createElement("div");
          attacksTitle.className = "attacks-title";
          attacksTitle.innerText = "‚öîÔ∏è –ê—Ç–∞–∫–∏";
          attacksBlock.appendChild(attacksTitle);
          p.attacks.forEach(attack => {
            const attackItem = document.createElement("div");
            attackItem.className = "attack-item";
            const attackName = document.createElement("div");
            attackName.className = "attack-name";
            attackName.innerText = attack.name;
            const attackStats = document.createElement("div");
            attackStats.className = "attack-stats";
            const dmgStr = formatDamage(attack.damage_dice || 0, attack.damage_die || 0, attack.damage_bonus || 0);
            attackStats.innerText = `+${attack.hit_bonus} –ø–æ–ø–∞–¥–∞–Ω–∏–µ, ${dmgStr} —É—Ä–æ–Ω (${attack.damage_type}), ${attack.range} —Ñ—É—Ç–æ–≤`;
            attackItem.appendChild(attackName);
            attackItem.appendChild(attackStats);
            attacksBlock.appendChild(attackItem);
          });
          card.appendChild(attacksBlock);
        }
        container.appendChild(card);
      });
      const selected = currentState.participants.find(x => x.id === selectedParticipantId);
      if (selectedParticipantId && selected) {
        hpBarRow.style.display = "flex";
        hpWho.innerText = selected.name;
      } else {
        hpBarRow.style.display = "none";
        hpWho.innerText = "HP";
      }
    }
    async function changeHp(participantId, delta) {
      try {
        setFlavorStatus("hp_change");
        await apiPost(`/participants/${participantId}/hp_change`, { delta });
        await loadState();
      } catch (e) {
        console.error(e);
        setFlavorStatus("error_hp");
      }
    }
    const hpBarRow = document.getElementById("hpBarRow");
    const hpWho = document.getElementById("hpWho");
    document.querySelectorAll(".hpbtn").forEach(b => {
      b.onclick = () => {
        const d = parseInt(b.dataset.d, 10);
        if (!selectedParticipantId) return;
        changeHp(selectedParticipantId, d);
      };
    });
    async function nextTurn() {
      if (!encounterId) return;
      try {
        setFlavorStatus("next_turn");
        await apiPost(`/encounters/${encounterId}/next_turn`, {});
        await loadState();
      } catch (e) {
        console.error(e);
        setFlavorStatus("error_next");
      }
    }
    async function finishEncounter() {
      if (!encounterId) return;
      const ok = confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å—Ö–≤–∞—Ç–∫—É?");
      if (!ok) return;
      try {
        setFlavorStatus("finish");
        await apiPost(`/encounters/${encounterId}/finish`, {});
        window.location.replace("/static/gm_campaigns.html");
      } catch (e) {
        console.error(e);
        setFlavorStatus("error_state");
      }
    }
    document.getElementById("nextTurnBtn").onclick = nextTurn;
    document.getElementById("finishBtn").onclick = finishEncounter;
    document.getElementById("backToCampaignsBtn").onclick = () => {
      window.location.href = "/static/gm_campaigns.html";
    };
    let toastTimeout = null;
    function showToast(text) {
      const el = document.getElementById("toast");
      if (!el) return;
      el.innerText = text;
      el.classList.add("show");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => el.classList.remove("show"), 2200);
    }
    function setStatus(text) {
      const el = document.getElementById("statusLine");
      if (el) el.innerText = text;
    }
    function clearStatus() { setStatus(""); }
    function setFlavorStatus(type) {
      switch (type) {
        case "loading_state": setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Å–æ—Å—Ç–æ—è–Ω–∏–µ‚Ä¶"); break;
        case "next_turn": showToast("–°–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥‚Ä¶"); break;
        case "hp_change": showToast("–ò–∑–º–µ–Ω—è—é HP‚Ä¶"); break;
        case "finish": showToast("–°—Ö–≤–∞—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."); break;
        case "error_state": showToast("–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."); break;
        case "error_hp": showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å HP."); break;
        case "error_next": showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ö–æ–¥."); break;
      }
    }
    if (tg && tg.ready) tg.ready();
    loadState();
  </script>
</body>
</html>